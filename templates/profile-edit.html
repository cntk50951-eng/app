<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¨è¼¯å­©å­è³‡æ–™ - AI Tutor</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .profile-header {
            text-align: center;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 3rem;
        }
        
        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .profile-age-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }
        
        .section-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .section-title .material-symbols-outlined {
            color: var(--primary-color);
        }
        
        .interest-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .interest-tag {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--background-light);
            border-radius: 2rem;
            font-size: 0.875rem;
        }
        
        .interest-tag.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary {
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .btn-secondary {
            width: 100%;
            padding: 1rem;
            margin-top: 0.5rem;
            background: var(--background-light);
            color: var(--text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--background-light);
            border-radius: var(--radius-lg);
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="page-container">
        <header class="header">
            <a href="/dashboard" class="back-btn">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <h1 class="page-title">ç·¨è¼¯è³‡æ–™</h1>
            <div style="width: 48px;"></div>
        </header>

        <main class="main-content" style="padding-bottom: 8rem;">
            <!-- ç”»åƒé¢„è§ˆ -->
            <div class="profile-header">
                <div class="profile-avatar" id="avatarPreview">
                    ğŸ‘¶
                </div>
                <div class="profile-name" id="nameDisplay">å°æœ‹å‹</div>
                <div class="profile-age-badge" id="ageDisplay">K2</div>
            </div>

            <!-- ç»Ÿè®¡ -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-symbols-outlined">analytics</span>
                    ä½¿ç”¨çµ±è¨ˆ
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="topicsCompleted">0</div>
                        <div class="stat-label">å·²å®Œæˆä¸»é¡Œ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalTime">0</div>
                        <div class="stat-label">ç·´ç¿’æ™‚é•·(åˆ†é˜)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="streakDays">0</div>
                        <div class="stat-label">é€£çºŒå¤©æ•¸</div>
                    </div>
                </div>
            </div>

            <!-- åŸºæœ¬ä¿¡æ¯ç¼–è¾‘ -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-symbols-outlined">person</span>
                    åŸºæœ¬è³‡æ–™
                </div>
                
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">å°æœ‹å‹æš±ç¨±</label>
                        <input type="text" class="form-input" id="childName" 
                               placeholder="è¼¸å…¥æš±ç¨±" maxlength="20">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å¹´é½¡</label>
                        <select class="form-select" id="childAge">
                            <option value="">é¸æ“‡å¹´é½¡</option>
                            <option value="K1">K1 (å¹¼å…’åœ’ä½ç­)</option>
                            <option value="K2">K2 (å¹¼å…’åœ’ä¸­ç­)</option>
                            <option value="K3">K3 (å¹¼å…’åœ’é«˜ç­)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ€§åˆ¥</label>
                        <div class="btn-group" id="genderGroup">
                            <button type="button" class="btn-toggle" data-value="male">ç”·ä»”</button>
                            <button type="button" class="btn-toggle" data-value="female">å¥³ä»”</button>
                            <button type="button" class="btn-toggle" data-value="other">å…¶ä»–/ä¸é€éœ²</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- å…´è¶£ç¼–è¾‘ -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-symbols-outlined">star</span>
                    èˆˆè¶£æ„›å¥½
                </div>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                    é¸æ“‡æœ€å¤š 5 å€‹èˆˆè¶£ (é»æ“Šé¸æ“‡/å–æ¶ˆ)
                </p>
                <div class="interest-tags" id="interestTags">
                    <!-- å…´è¶£æ ‡ç­¾å°†é€šè¿‡ JS å¡«å…… -->
                </div>
            </div>

            <!-- ç›®æ ‡å­¦æ ¡ -->
            <div class="section-card">
                <div class="section-title">
                    <span class="material-symbols-outlined">school</span>
                    ç›®æ¨™å­¸æ ¡é¡å‹
                </div>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                    é¸æ“‡æƒ³å ±è€ƒçš„å­¸æ ¡é¡å‹ (å¯é¸å¤šå€‹)
                </p>
                <div id="schoolTypes">
                    <label class="checkbox-item">
                        <input type="checkbox" name="school" value="academic">
                        <span class="checkmark"></span>
                        <div>
                            <strong>å­¸è¡“å‹</strong>
                            <small>DBS / SPCC ç­‰</small>
                        </div>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="school" value="holistic">
                        <span class="checkmark"></span>
                        <div>
                            <strong>å…¨äººå‹</strong>
                            <small>è‹±è¯ / TSL ç­‰</small>
                        </div>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="school" value="international">
                        <span class="checkmark"></span>
                        <div>
                            <strong>åœ‹éš›å‹</strong>
                            <small>CKY / æ¸¯åŒ ç­‰</small>
                        </div>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="school" value="traditional">
                        <span class="checkmark"></span>
                        <div>
                            <strong>å‚³çµ±åæ ¡</strong>
                            <small>KTS / SFA ç­‰</small>
                        </div>
                    </label>
                </div>
            </div>

            <!-- æŒ‰é’® -->
            <div style="padding: 0 1rem;">
                <button class="btn-primary" onclick="saveProfile()">
                    <span class="material-symbols-outlined">save</span>
                    ä¿å­˜æ›´æ”¹
                </button>
                <button class="btn-secondary" onclick="cancelEdit()">
                    å–æ¶ˆ
                </button>
            </div>

            <!-- å±é™©æ“ä½œ -->
            <div style="padding: 1rem; text-align: center;">
                <button onclick="deleteProfile()" style="color: var(--error-color); background: none; border: none; font-size: 0.875rem; cursor: pointer;">
                    åˆªé™¤å­©å­è³‡æ–™
                </button>
            </div>
        </main>
    </div>

    <script>
        // é…ç½®
        const INTERESTS = [
            { id: 'dinosaurs', emoji: 'ğŸ¦•', name: 'æé¾' },
            { id: 'lego', emoji: 'ğŸ§±', name: 'Lego' },
            { id: 'art', emoji: 'ğŸ¨', name: 'ç•«ç•«' },
            { id: 'sports', emoji: 'âš½', name: 'é‹å‹•' },
            { id: 'music', emoji: 'ğŸµ', name: 'éŸ³æ¨‚' },
            { id: 'reading', emoji: 'ğŸ“š', name: 'é–±è®€' },
            { id: 'science', emoji: 'ğŸ”¬', name: 'ç§‘å­¸' },
            { id: 'cooking', emoji: 'ğŸ³', name: 'ç…®é£¯ä»”' },
            { id: 'cars', emoji: 'ğŸš—', name: 'è»Š' },
            { id: 'planes', emoji: 'âœˆï¸', name: 'é£›æ©Ÿ' },
            { id: 'animals', emoji: 'ğŸ¶', name: 'å‹•ç‰©' },
            { id: 'nature', emoji: 'ğŸŒ³', name: 'å¤§è‡ªç„¶' },
            { id: 'performing', emoji: 'ğŸ­', name: 'è¡¨æ¼”' },
            { id: 'gaming', emoji: 'ğŸ®', name: 'éŠæˆ²' },
            { id: 'swimming', emoji: 'ğŸŠ', name: 'æ¸¸æ³³' }
        ];
        
        let currentProfile = {};
        let selectedInterests = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            renderInterestTags();
            setupGenderButtons();
        });
        
        // åŠ è½½ç”»åƒæ•°æ®
        async function loadProfile() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                
                if (data.profile_complete) {
                    currentProfile = data;
                    
                    // å¡«å……è¡¨å•
                    document.getElementById('childName').value = data.child_name || '';
                    document.getElementById('childAge').value = data.child_age || '';
                    selectedInterests = data.child_interests || [];
                    document.getElementById('targetSchools').value = data.target_schools || [];
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateDisplay();
                }
            } catch (e) {
                console.error('Error loading profile:', e);
            }
        }
        
        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            const name = document.getElementById('childName').value || 'å°æœ‹å‹';
            const age = document.getElementById('childAge').value || 'K2';
            const gender = document.querySelector('.btn-toggle.active')?.dataset.value;
            
            document.getElementById('nameDisplay').textContent = name;
            document.getElementById('ageDisplay').textContent = age;
            document.getElementById('avatarPreview').textContent = 
                gender === 'female' ? 'ğŸ‘§' : 'ğŸ‘¦';
        }
        
        // æ¸²æŸ“å…´è¶£æ ‡ç­¾
        function renderInterestTags() {
            const container = document.getElementById('interestTags');
            container.innerHTML = '';
            
            INTERESTS.forEach(interest => {
                const tag = document.createElement('button');
                tag.type = 'button';
                tag.className = `interest-tag ${selectedInterests.includes(interest.id) ? 'selected' : ''}`;
                tag.innerHTML = `${interest.emoji} ${interest.name}`;
                tag.onclick = () => toggleInterest(interest.id, tag);
                container.appendChild(tag);
            });
        }
        
        // åˆ‡æ¢å…´è¶£
        function toggleInterest(id, element) {
            if (selectedInterests.includes(id)) {
                selectedInterests = selectedInterests.filter(i => i !== id);
                element.classList.remove('selected');
            } else {
                if (selectedInterests.length >= 5) {
                    alert('æœ€å¤šé¸æ“‡ 5 å€‹èˆˆè¶£ï¼');
                    return;
                }
                selectedInterests.push(id);
                element.classList.add('selected');
            }
        }
        
        // è®¾ç½®æ€§åˆ«æŒ‰é’®
        function setupGenderButtons() {
            document.querySelectorAll('.btn-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateDisplay();
                });
            });
        }
        
        // ä¿å­˜ç”»åƒ
        async function saveProfile() {
            const name = document.getElementById('childName').value.trim();
            const age = document.getElementById('childAge').value;
            const gender = document.querySelector('.btn-toggle.active')?.dataset.value;
            const schools = Array.from(document.querySelectorAll('input[name="school"]:checked'))
                .map(cb => cb.value);
            
            if (!name) {
                alert('è«‹è¼¸å…¥å°æœ‹å‹çš„æš±ç¨±ï¼');
                return;
            }
            
            if (!age) {
                alert('è«‹é¸æ“‡å°æœ‹å‹çš„å¹´é½¡ï¼');
                return;
            }
            
            try {
                // ä¿å­˜åŸºæœ¬ä¿¡æ¯
                let response = await fetch('/child-profile/step-1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `child_name=${encodeURIComponent(name)}&child_age=${age}&child_gender=${gender || ''}`
                });
                
                if (response.ok) {
                    // ä¿å­˜å…´è¶£
                    for (const interest of selectedInterests) {
                        await fetch('/child-profile/step-2', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `interests=${interest}`
                        });
                    }
                    
                    // ä¿å­˜å­¦æ ¡
                    for (const school of schools) {
                        await fetch('/child-profile/step-3', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `target_schools=${school}`
                        });
                    }
                    
                    alert('è³‡æ–™å·²ä¿å­˜ï¼âœ…');
                    window.location.href = '/dashboard';
                }
            } catch (e) {
                console.error('Error saving profile:', e);
                alert('ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ï¼');
            }
        }
        
        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            if (confirm('ç¢ºå®šå–æ¶ˆï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°‡æœƒä¸Ÿå¤±ã€‚')) {
                window.location.href = '/dashboard';
            }
        }
        
        // åˆ é™¤ç”»åƒ
        function deleteProfile() {
            if (confirm('ç¢ºå®šè¦åˆªé™¤å­©å­è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ï¼')) {
                if (confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤å—ï¼Ÿ')) {
                    alert('æ­¤åŠŸèƒ½éœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼Œè«‹è¯ç¹«å®¢æœã€‚');
                }
            }
        }
        
        // å®æ—¶æ›´æ–°æ˜¾ç¤º
        document.getElementById('childName').addEventListener('input', updateDisplay);
        document.getElementById('childAge').addEventListener('change', updateDisplay);
    </script>
</body>
</html>
