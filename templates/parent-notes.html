<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶é•·ç­†è¨˜ - AI Tutor</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .notes-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
        }
        
        .notes-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .notes-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .quick-note-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: var(--shadow-sm);
        }
        
        .topic-selector {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .topic-chip {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            background: var(--background-light);
            border-radius: 2rem;
            font-size: 0.875rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .topic-chip.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .template-question {
            background: var(--background-light);
            padding: 1rem;
            border-radius: var(--radius-lg);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .template-question strong {
            color: var(--primary-color);
        }
        
        .note-textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 1rem;
        }
        
        .note-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .score-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .score-btn {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .score-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }
        
        .score-emoji {
            font-size: 1.5rem;
            display: block;
        }
        
        .history-card {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: var(--radius-lg);
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
        }
        
        .history-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .history-content {
            flex: 1;
            min-width: 0;
        }
        
        .history-topic {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .history-text {
            font-size: 0.875rem;
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .history-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }
        
        .empty-state .material-symbols-outlined {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <header class="header">
            <a href="/dashboard" class="back-btn">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <h1 class="page-title">å®¶é•·ç­†è¨˜</h1>
            <div style="width: 48px;"></div>
        </header>

        <main class="main-content" style="padding-bottom: 8rem;">
            <!-- å¤´éƒ¨ -->
            <div class="notes-header">
                <div class="notes-title">ğŸ“ è¨˜éŒ„ç·´ç¿’</div>
                <div class="notes-subtitle">è§€å¯Ÿå°æœ‹å‹æ—¢è¡¨ç¾ï¼Œç•™ä½å¯¦ç”¨å»ºè­°</div>
            </div>

            <!-- å¿«é€Ÿç¬”è®° -->
            <div class="quick-note-card">
                <div class="section-title" style="margin-bottom: 1rem;">
                    <span class="material-symbols-outlined">edit</span>
                    æ–°å¢ç­†è¨˜
                </div>
                
                <!-- ä¸»é¢˜é€‰æ‹© -->
                <div class="topic-selector" id="topicSelector">
                    <button class="topic-chip active" data-topic="self-introduction">è‡ªæˆ‘ä»‹ç´¹</button>
                    <button class="topic-chip" data-topic="interests">èˆˆè¶£æ„›å¥½</button>
                    <button class="topic-chip" data-topic="family">å®¶åº­ä»‹ç´¹</button>
                    <button class="topic-chip" data-topic="observation">è§€å¯ŸåŠ›</button>
                    <button class="topic-chip" data-topic="scenarios">è™•å¢ƒé¡Œ</button>
                </div>
                
                <!-- æ¨¡æ¿é—®é¢˜ -->
                <div id="templateQuestions">
                    <!-- é€šè¿‡ JS å¡«å…… -->
                </div>
                
                <!-- ç¬”è®°å†…å®¹ -->
                <textarea class="note-textarea" id="noteContent" 
                          placeholder="è¨˜éŒ„å°æœ‹å‹ä»Šæ—¥æ—¢è¡¨ç¾...&#10;&#10;ä¾‹å¦‚ï¼šä»Šæ—¥å°æ˜ä»‹ç´¹è‡ªå·±å¥½å»ï¼Œä¸»å‹•æœ›ä½é¡é ­ï¼Œè²éŸ³å¤ å¤§è²ã€‚ä½†ä¿‚è¬›åˆ°é¾æ„æ—¢å˜¢æ™‚è©å½™æœ‰å•²å°‘ï¼Œå¯ä»¥åŠ å¤šå•²å½¢å®¹è©ã€‚"></textarea>
                
                <!-- è¯„åˆ† -->
                <div class="score-selector">
                    <button class="score-btn" data-score="1">
                        <span class="score-emoji">ğŸ˜Ÿ</span>
                        éœ€åŠªåŠ›
                    </button>
                    <button class="score-btn" data-score="2">
                        <span class="score-emoji">ğŸ™‚</span>
                        é‚„å¯ä»¥
                    </button>
                    <button class="score-btn" data-score="3">
                        <span class="score-emoji">ğŸ˜Š</span>
                        ä¸éŒ¯
                    </button>
                    <button class="score-btn" data-score="4">
                        <span class="score-emoji">ğŸ˜„</span>
                        å¥½å»
                    </button>
                    <button class="score-btn active" data-score="5">
                        <span class="score-emoji">ğŸŒŸ</span>
                        è¶…æ£’
                    </button>
                </div>
                
                <button class="btn-primary" onclick="saveNote()">
                    <span class="material-symbols-outlined">save</span>
                    ä¿å­˜ç­†è¨˜
                </button>
            </div>

            <!-- å†å²è®°å½• -->
            <div style="padding: 0 1rem;">
                <div class="section-title" style="margin: 1rem 0;">
                    <span class="material-symbols-outlined">history</span>
                    æ­·å²è¨˜éŒ„
                </div>
                
                <div id="historyList">
                    <!-- é€šè¿‡ JS å¡«å…… -->
                </div>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <span class="material-symbols-outlined">note_add</span>
                    <p>æš«æ™‚æœªæœ‰ç­†è¨˜</p>
                    <p style="font-size: 0.875rem;">è¨˜éŒ„å°æœ‹å‹æ—¢ç·´ç¿’æƒ…æ³ï¼Œå¹«åŠ©è¿½è¹¤é€²åº¦ï¼</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const TOPICS = {
            'self-introduction': { emoji: 'ğŸ‘‹', name: 'è‡ªæˆ‘ä»‹ç´¹' },
            'interests': { emoji: 'â­', name: 'èˆˆè¶£æ„›å¥½' },
            'family': { emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', name: 'å®¶åº­ä»‹ç´¹' },
            'observation': { emoji: 'ğŸ‘€', name: 'è§€å¯ŸåŠ›' },
            'scenarios': { emoji: 'ğŸ­', name: 'è™•å¢ƒé¡Œ' }
        };
        
        const TEMPLATES = {
            'self-introduction': {
                questions: [
                    'å°æœ‹å‹ä»‹ç´¹è‡ªå·±æ™‚è¡¨ç¾å¾—é»æ¨£ï¼Ÿ',
                    'æœ‰å†‡é‚Šéƒ¨åˆ†è¬›å¾—ç‰¹åˆ¥å¥½ï¼Ÿ',
                    'é‚Šéƒ¨åˆ†éœ€è¦å¤šå•²ç·´ç¿’ï¼Ÿ'
                ],
                suggestions: 'å¯ä»¥å°é¡ç·´ç¿’ï¼Œç‡å“è‡ªå·±æ—¢è¡¨æƒ…åŒå§¿å‹¢'
            },
            'interests': {
                questions: [
                    'å°æœ‹å‹é»æ¨£æè¿°è‡ªå·±æ—¢èˆˆè¶£ï¼Ÿ',
                    'å¯ä»¥å””å¯ä»¥è¬›å‡ºå…·é«”ä¾‹å­ï¼Ÿ',
                    'ç”¨å’—å’©å½¢å®¹è©ï¼Ÿ'
                ],
                suggestions: 'ç”¨ã€Œå› ç‚º...æ‰€ä»¥...ã€å¥å¼ï¼Œæº–å‚™å¤šå¹¾å€‹èˆˆè¶£ç›¸é—œæ—¢è©å½™'
            },
            'family': {
                questions: [
                    'å°æœ‹å‹è­˜å””è­˜ä»‹ç´¹å±‹ä¼äººï¼Ÿ',
                    'å¯å””å¯ä»¥è¬›å‡ºå±‹ä¼äººæ—¢ç‰¹é»ï¼Ÿ'
                ],
                suggestions: 'å¯ä»¥å½±å•²å®¶åº­ç›¸ï¼Œç­‰å°æœ‹å‹æŒ‡ä½åšŸè¬›'
            },
            'observation': {
                questions: [
                    'å°æœ‹å‹æœ‰å†‡ç‡æ¸…æ¥šå¼µåœ–ï¼Ÿ',
                    'è¬›å¾—å‡ºå¹¾å¤šæ¨£é‡ï¼Ÿ',
                    'æè¿°æ—¢æ¬¡åºæ¸…å””æ¸…æ¥šï¼Ÿ'
                ],
                suggestions: 'æ•™ã€Œç”±å·¦åˆ°å³ã€ç”±ä¸Šåˆ°ä¸‹ã€å’ç‡'
            },
            'scenarios': {
                questions: [
                    'å°æœ‹å‹è­˜å””è­˜è™•ç†å‘¢å€‹æƒ…æ³ï¼Ÿ',
                    'ç­”æ¡ˆåˆç†å””åˆç†ï¼Ÿ'
                ],
                suggestions: 'ç”¨è§’è‰²æ‰®æ¼”æ—¢æ–¹å¼ç·´ç¿’'
            }
        };
        
        let currentTopic = 'self-introduction';
        let currentScore = 5;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadTemplate(currentTopic);
            loadHistory();
            setupEventListeners();
        });
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // ä¸»é¢˜é€‰æ‹©
            document.querySelectorAll('.topic-chip').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.topic-chip').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTopic = btn.dataset.topic;
                    loadTemplate(currentTopic);
                });
            });
            
            // è¯„åˆ†æŒ‰é’®
            document.querySelectorAll('.score-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentScore = parseInt(btn.dataset.score);
                });
            });
        }
        
        // åŠ è½½æ¨¡æ¿
        function loadTemplate(topic) {
            const template = TEMPLATES[topic] || {
                questions: ['ç·´ç¿’éç¨‹é»æ¨£ï¼Ÿ', 'é‚Šéƒ¨åˆ†åšå¾—å¥½ï¼Ÿ', 'é‚Šéƒ¨åˆ†éœ€è¦æ”¹é€²ï¼Ÿ'],
                suggestions: 'é¼“å‹µå°æœ‹å‹'
            };
            
            const container = document.getElementById('templateQuestions');
            container.innerHTML = `
                <div style="margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                    <strong>æ€è€ƒæ–¹å‘ï¼š</strong>
                </div>
                ${template.questions.map(q => `
                    <div class="template-question">
                        <strong>ğŸ’¡ ${q}</strong>
                    </div>
                `).join('')}
                <div style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border-radius: var(--radius-lg); font-size: 0.875rem;">
                    <span style="font-size: 1rem;">ğŸ“Œ</span> ${template.suggestions}
                </div>
            `;
        }
        
        // åŠ è½½å†å²
        async function loadHistory() {
            try {
                const response = await fetch('/api/notes?limit=10');
                const data = await response.json();
                
                const container = document.getElementById('historyList');
                const emptyState = document.getElementById('emptyState');
                
                if (!data.notes || data.notes.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                container.innerHTML = data.notes.map(note => {
                    const topic = TOPICS[note.topic_id] || { emoji: 'ğŸ“', name: 'ç­†è¨˜' };
                    const scoreEmojis = ['','ğŸ˜Ÿ','ğŸ™‚','ğŸ˜Š','ğŸ˜„','ğŸŒŸ'];
                    
                    return `
                        <div class="history-card">
                            <div class="history-avatar">${topic.emoji}</div>
                            <div class="history-content">
                                <div class="history-topic">${topic.name} Â· ${scoreEmojis[note.score || 5]}</div>
                                <div class="history-text">${note.content}</div>
                                <div class="history-time">${formatTime(note.created_at)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Error loading notes:', e);
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'å‰›å‰›';
            if (diff < 3600000) return `${Math.floor(diff/60000)} åˆ†é˜å‰`;
            if (diff < 86400000) return `${Math.floor(diff/3600000)} å°æ™‚å‰`;
            return date.toLocaleDateString('zh-HK');
        }
        
        // ä¿å­˜ç¬”è®°
        async function saveNote() {
            const content = document.getElementById('noteContent').value.trim();
            
            if (!content) {
                alert('è«‹è¼¸å…¥ç­†è¨˜å…§å®¹ï¼');
                return;
            }
            
            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic_id: currentTopic,
                        content: content,
                        score: currentScore
                    })
                });
                
                if (response.ok) {
                    alert('ç­†è¨˜å·²ä¿å­˜ï¼âœ…');
                    document.getElementById('noteContent').value = '';
                    currentScore = 5;
                    document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('.score-btn[data-score="5"]').classList.add('active');
                    loadHistory();
                }
            } catch (e) {
                console.error('Error saving note:', e);
                alert('ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ï¼');
            }
        }
    </script>
</body>
</html>
