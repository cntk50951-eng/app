<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家长协作空间 - AI Tutor</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        :root {
            --primary: #1E94F6;
            --secondary: #8B5CF6;
            --success: #22C55E;
            --warning: #F59E0B;
            --error: #EF4444;
            --bg: #F9FAFB;
            --text: #111827;
            --text-secondary: #6B7280;
            --school-selection: #3B82F6;
            --interview-prep: #8B5CF6;
            --experience: #22C55E;
            --other: #6B7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 70px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Search Bar */
        .search-bar {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 15px;
            margin-left: 8px;
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 8px;
            padding: 0 16px 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .category-tabs::-webkit-scrollbar {
            display: none;
        }

        .category-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: white;
            color: var(--text-secondary);
        }

        .category-tab.active {
            background: var(--primary);
            color: white;
        }

        .category-tab[data-category="school_selection"] { border: 1px solid var(--school-selection); color: var(--school-selection); }
        .category-tab[data-category="school_selection"].active { background: var(--school-selection); color: white; }
        .category-tab[data-category="interview_prep"] { border: 1px solid var(--interview-prep); color: var(--interview-prep); }
        .category-tab[data-category="interview_prep"].active { background: var(--interview-prep); color: white; }
        .category-tab[data-category="experience"] { border: 1px solid var(--experience); color: var(--experience); }
        .category-tab[data-category="experience"].active { background: var(--experience); color: white; }

        /* Content Tabs */
        .content-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            margin: 0 16px 16px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .content-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .content-tab.active {
            background: var(--primary);
            color: white;
        }

        /* List Container */
        .list-container {
            padding: 0 16px;
        }

        /* Question Card */
        .question-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .question-card .category-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .category-tag.school_selection { background: rgba(59, 130, 246, 0.1); color: var(--school-selection); }
        .category-tag.interview_prep { background: rgba(139, 92, 246, 0.1); color: var(--interview-prep); }
        .category-tag.experience { background: rgba(34, 197, 94, 0.1); color: var(--experience); }
        .category-tag.other { background: rgba(107, 114, 128, 0.1); color: var(--other); }

        .question-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .question-card .preview {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .question-card .meta {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .question-card .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .question-card .resolved-badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* Post Card */
        .post-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .post-card .cover-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .post-card .content {
            padding: 16px;
        }

        .post-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .post-card .tags {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .post-card .tag {
            padding: 2px 8px;
            background: rgba(30, 148, 246, 0.1);
            color: var(--primary);
            border-radius: 8px;
            font-size: 12px;
        }

        .post-card .meta {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Case Card */
        .case-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .case-card .school-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .case-card .school-type {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(139, 92, 246, 0.1);
            color: var(--secondary);
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 12px;
        }

        .case-card .rating {
            display: flex;
            gap: 2px;
            margin-bottom: 8px;
        }

        .case-card .rating .star {
            color: #FFD700;
        }

        .case-card .rating .star.empty {
            color: #E5E7EB;
        }

        .case-card .questions-preview {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .case-card .meta {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(30, 148, 246, 0.4);
            cursor: pointer;
            z-index: 90;
            transition: transform 0.2s;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1583dc;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #E5E7EB;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .bottom-nav .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary);
            padding: 8px 16px;
            transition: color 0.2s;
        }

        .bottom-nav .nav-item.active {
            color: var(--primary);
        }

        .bottom-nav .nav-item span:first-child {
            font-size: 24px;
        }

        .bottom-nav .nav-item span:last-child {
            font-size: 12px;
            margin-top: 2px;
        }

        /* Section Title */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin: 20px 16px 12px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>家长协作空间</h1>
        <p>与万千家长交流择校与面试经验</p>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
        <span class="material-symbols-outlined" style="color: var(--text-secondary);">search</span>
        <input type="text" id="searchInput" placeholder="搜索问题、经验、案例...">
    </div>

    <!-- Category Tabs (for questions) -->
    <div class="category-tabs" id="categoryTabs">
        <button class="category-tab active" data-category="">全部</button>
        <button class="category-tab" data-category="school_selection">选校</button>
        <button class="category-tab" data-category="interview_prep">面试准备</button>
        <button class="category-tab" data-category="experience">经验分享</button>
        <button class="category-tab" data-category="other">其他</button>
    </div>

    <!-- Content Tabs -->
    <div class="content-tabs">
        <div class="content-tab active" data-tab="questions">问答社区</div>
        <div class="content-tab" data-tab="experiences">经验分享</div>
        <div class="content-tab" data-tab="cases">面试案例</div>
    </div>

    <!-- Questions List -->
    <div class="list-container" id="questionsList">
        <div class="loading">
            <div class="spinner"></div>
            <p>加载中...</p>
        </div>
    </div>

    <!-- Experiences List -->
    <div class="list-container" id="experiencesList" style="display: none;">
        <div class="loading">
            <div class="spinner"></div>
            <p>加载中...</p>
        </div>
    </div>

    <!-- Cases List -->
    <div class="list-container" id="casesList" style="display: none;">
        <div class="loading">
            <div class="spinner"></div>
            <p>加载中...</p>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab" id="fabBtn">
        <span class="material-symbols-outlined">add</span>
    </div>

    <!-- Create Question Modal -->
    <div class="modal" id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>提问</h2>
                <button class="modal-close" onclick="closeModal('questionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>分类</label>
                    <select id="questionCategory">
                        <option value="school_selection">选校咨询</option>
                        <option value="interview_prep">面试准备</option>
                        <option value="experience">经验分享</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>问题标题</label>
                    <input type="text" id="questionTitle" placeholder="简要描述你的问题" maxlength="100">
                </div>
                <div class="form-group">
                    <label>详细描述</label>
                    <textarea id="questionContent" placeholder="详细描述你的问题，有助于获得更好的回答" minlength="20"></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="questionAnonymous" style="width: auto;">
                        匿名发布
                    </label>
                </div>
                <button class="btn btn-primary" onclick="submitQuestion()">发布问题</button>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div class="modal" id="postModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>分享经验</h2>
                <button class="modal-close" onclick="closeModal('postModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>标题</label>
                    <input type="text" id="postTitle" placeholder="经验分享标题" maxlength="100">
                </div>
                <div class="form-group">
                    <label>内容</label>
                    <textarea id="postContent" placeholder="分享你的面试准备经验、择校心得..." style="min-height: 200px;"></textarea>
                </div>
                <div class="form-group">
                    <label>标签（用逗号分隔）</label>
                    <input type="text" id="postTags" placeholder="如: 面试技巧, 经验分享">
                </div>
                <button class="btn btn-primary" onclick="submitPost()">发布经验</button>
            </div>
        </div>
    </div>

    <!-- Create Case Modal -->
    <div class="modal" id="caseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>分享面试案例</h2>
                <button class="modal-close" onclick="closeModal('caseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>学校名称</label>
                    <input type="text" id="caseSchool" placeholder="如: DBS, SPCC">
                </div>
                <div class="form-group">
                    <label>学校类型</label>
                    <select id="caseType">
                        <option value="academic">学术型</option>
                        <option value="holistic">全人型</option>
                        <option value="international">国际型</option>
                        <option value="traditional">传统名校</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>面试日期</label>
                    <input type="date" id="caseDate">
                </div>
                <div class="form-group">
                    <label>面试问题（每行一个）</label>
                    <textarea id="caseQuestions" placeholder="你叫什么名字？&#10;你喜欢什么动物？"></textarea>
                </div>
                <div class="form-group">
                    <label>面试考察重点</label>
                    <input type="text" id="caseKeyPoints" placeholder="如: 表达能力, 逻辑思维">
                </div>
                <div class="form-group">
                    <label>整体评分 (1-5)</label>
                    <select id="caseRating">
                        <option value="5">5星 - 非常满意</option>
                        <option value="4">4星 - 满意</option>
                        <option value="3">3星 - 一般</option>
                        <option value="2">2星 - 不满意</option>
                        <option value="1">1星 - 非常不满意</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>详细评价</label>
                    <textarea id="caseReview" placeholder="分享面试的整体感受和建议（至少50字）"></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="caseAnonymous" checked style="width: auto;">
                        匿名发布
                    </label>
                </div>
                <button class="btn btn-primary" onclick="submitCase()">提交案例</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="{{ url_for('dashboard') }}" class="nav-item">
            <span class="material-symbols-outlined">home</span>
            <span>主页</span>
        </a>
        <a href="#" class="nav-item active">
            <span class="material-symbols-outlined">forum</span>
            <span>社群</span>
        </a>
        <a href="{{ url_for('practice_center') }}" class="nav-item">
            <span class="material-symbols-outlined">school</span>
            <span>练习</span>
        </a>
        <a href="{{ url_for('reports_page') }}" class="nav-item">
            <span class="material-symbols-outlined">assessment</span>
            <span>报告</span>
        </a>
    </nav>

    <script>
        let currentTab = 'questions';
        let currentCategory = '';
        let currentPage = 1;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadQuestions();

            // Content Tab Click
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentTab = this.dataset.tab;
                    showCurrentTab();
                });
            });

            // Category Tab Click
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    loadQuestions();
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', debounce(function(e) {
                loadQuestions();
            }, 500));

            // FAB Click
            document.getElementById('fabBtn').addEventListener('click', function() {
                if (currentTab === 'questions') {
                    openModal('questionModal');
                } else if (currentTab === 'experiences') {
                    openModal('postModal');
                } else if (currentTab === 'cases') {
                    openModal('caseModal');
                }
            });
        });

        function showCurrentTab() {
            document.getElementById('questionsList').style.display = currentTab === 'questions' ? 'block' : 'none';
            document.getElementById('experiencesList').style.display = currentTab === 'experiences' ? 'block' : 'none';
            document.getElementById('casesList').style.display = currentTab === 'cases' ? 'block' : 'none';
            document.getElementById('categoryTabs').style.display = currentTab === 'questions' ? 'flex' : 'none';

            if (currentTab === 'questions') loadQuestions();
            else if (currentTab === 'experiences') loadExperiences();
            else if (currentTab === 'cases') loadCases();
        }

        function loadQuestions() {
            const container = document.getElementById('questionsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>加载中...</p></div>';

            const keyword = document.getElementById('searchInput').value;
            let url = '/api/community/questions?page=1&limit=20';
            if (currentCategory) url += `&category=${currentCategory}`;
            if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.questions && data.questions.length > 0) {
                        container.innerHTML = data.questions.map(q => `
                            <div class="question-card" onclick="viewQuestion(${q.id})">
                                <span class="category-tag ${q.category}">${getCategoryLabel(q.category)}</span>
                                <h3>${escapeHtml(q.title)}</h3>
                                <p class="preview">${escapeHtml(q.content.substring(0, 100))}</p>
                                <div class="meta">
                                    <span class="meta-item">
                                        <span class="material-symbols-outlined" style="font-size: 16px;">chat_bubble</span>
                                        ${q.answer_count} 回答
                                    </span>
                                    <span class="meta-item">
                                        <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                                        ${q.view_count} 浏览
                                    </span>
                                    ${q.is_resolved ? '<span class="resolved-badge">已解决</span>' : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">forum</div>
                                <h3>暂无问题</h3>
                                <p>点击下方按钮发布第一个问题</p>
                            </div>
                        `;
                    }
                })
                .catch(err => {
                    container.innerHTML = '<div class="empty-state"><p>加载失败，请重试</p></div>';
                });
        }

        function loadExperiences() {
            const container = document.getElementById('experiencesList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>加载中...</p></div>';

            const keyword = document.getElementById('searchInput').value;
            let url = '/api/community/experiences?page=1&limit=20';
            if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.posts && data.posts.length > 0) {
                        container.innerHTML = data.posts.map(p => `
                            <div class="post-card">
                                ${p.cover_image ? `<img class="cover-image" src="${p.cover_image}" alt="">` : ''}
                                <div class="content">
                                    <h3>${escapeHtml(p.title)}</h3>
                                    ${p.tags ? `<div class="tags">${p.tags.split(',').map(t => `<span class="tag">${escapeHtml(t.trim())}</span>`).join('')}</div>` : ''}
                                    <p class="preview">${escapeHtml(p.content.substring(0, 100))}</p>
                                    <div class="meta">
                                        <span class="meta-item">
                                            <span class="material-symbols-outlined" style="font-size: 16px;">thumb_up</span>
                                            ${p.like_count}
                                        </span>
                                        <span class="meta-item">
                                            <span class="material-symbols-outlined" style="font-size: 16px;">chat_bubble</span>
                                            ${p.comment_count}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">article</div>
                                <h3>暂无经验分享</h3>
                                <p>点击下方按钮分享你的经验</p>
                            </div>
                        `;
                    }
                })
                .catch(err => {
                    container.innerHTML = '<div class="empty-state"><p>加载失败，请重试</p></div>';
                });
        }

        function loadCases() {
            const container = document.getElementById('casesList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>加载中...</p></div>';

            const keyword = document.getElementById('searchInput').value;
            let url = '/api/community/cases?page=1&limit=20';
            if (keyword) url += `&school_name=${encodeURIComponent(keyword)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.cases && data.cases.length > 0) {
                        container.innerHTML = data.cases.map(c => `
                            <div class="case-card">
                                <div class="school-name">${escapeHtml(c.school_name)}</div>
                                <span class="school-type">${getSchoolTypeLabel(c.school_type)}</span>
                                <div class="rating">
                                    ${[1,2,3,4,5].map(i => `<span class="material-symbols-outlined star ${i <= c.overall_rating ? '' : 'empty'}">star</span>`).join('')}
                                </div>
                                <p class="questions-preview">${c.questions_preview ? c.questions_preview.join(' / ') : ''}</p>
                                <div class="meta">
                                    <span>${c.interview_date}</span>
                                    <span>${c.helpful_count} 人认为有帮助</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">school</div>
                                <h3>暂无面试案例</h3>
                                <p>点击下方按钮分享面试经历</p>
                            </div>
                        `;
                    }
                })
                .catch(err => {
                    container.innerHTML = '<div class="empty-state"><p>加载失败，请重试</p></div>';
                });
        }

        function viewQuestion(id) {
            // For now, just log - would navigate to detail page
            console.log('View question:', id);
        }

        function getCategoryLabel(category) {
            const labels = {
                'school_selection': '选校',
                'interview_prep': '面试准备',
                'experience': '经验分享',
                'other': '其他'
            };
            return labels[category] || category;
        }

        function getSchoolTypeLabel(type) {
            const labels = {
                'academic': '学术型',
                'holistic': '全人型',
                'international': '国际型',
                'traditional': '传统名校'
            };
            return labels[type] || type;
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function submitQuestion() {
            const category = document.getElementById('questionCategory').value;
            const title = document.getElementById('questionTitle').value;
            const content = document.getElementById('questionContent').value;
            const isAnonymous = document.getElementById('questionAnonymous').checked;

            if (!title || !content) {
                alert('请填写完整信息');
                return;
            }

            fetch('/api/community/questions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({category, title, content, is_anonymous: isAnonymous})
            })
            .then(res => res.json())
            .then(data => {
                if (data.id) {
                    closeModal('questionModal');
                    loadQuestions();
                    document.getElementById('questionTitle').value = '';
                    document.getElementById('questionContent').value = '';
                } else {
                    alert(data.error || '发布失败');
                }
            });
        }

        function submitPost() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const tagsStr = document.getElementById('postTags').value;
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()) : [];

            if (!title || !content) {
                alert('请填写完整信息');
                return;
            }

            fetch('/api/community/experiences', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, content, tags})
            })
            .then(res => res.json())
            .then(data => {
                if (data.id) {
                    closeModal('postModal');
                    loadExperiences();
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                    document.getElementById('postTags').value = '';
                } else {
                    alert(data.error || '发布失败');
                }
            });
        }

        function submitCase() {
            const school_name = document.getElementById('caseSchool').value;
            const school_type = document.getElementById('caseType').value;
            const interview_date = document.getElementById('caseDate').value;
            const questionsText = document.getElementById('caseQuestions').value;
            const key_points = document.getElementById('caseKeyPoints').value;
            const overall_rating = parseInt(document.getElementById('caseRating').value);
            const review_content = document.getElementById('caseReview').value;
            const isAnonymous = document.getElementById('caseAnonymous').checked;

            if (!school_name || !interview_date || !questionsText || !review_content) {
                alert('请填写完整信息');
                return;
            }

            const questions = questionsText.split('\n').filter(q => q.trim()).map(q => ({
                question: q.trim(),
                feedback: ''
            }));

            fetch('/api/community/cases', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    school_name,
                    school_type,
                    interview_date,
                    questions,
                    key_points,
                    overall_rating,
                    review_content,
                    is_anonymous: isAnonymous
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.id) {
                    closeModal('caseModal');
                    alert('案例已提交，待审核后发布');
                    loadCases();
                    document.getElementById('caseSchool').value = '';
                    document.getElementById('caseQuestions').value = '';
                    document.getElementById('caseReview').value = '';
                } else {
                    alert(data.error || '提交失败');
                }
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
