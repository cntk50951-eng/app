<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{{ topic.title }} - AI Tutor</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error State */
        .error-state {
            padding: 2rem;
            text-align: center;
            color: var(--error-color);
        }
        
        .error-state .material-symbols-outlined {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        /* Regenerate Button */
        .regenerate-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--background-light);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .regenerate-btn:hover {
            background: var(--background);
        }
        
        .regenerate-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .regenerate-btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-secondary);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        
        .regenerate-btn.loading .spinner {
            display: inline-block;
        }
        
        /* Coming Soon Badge */
        .coming-soon-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
            background: var(--background-light);
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .coming-soon-badge .material-symbols-outlined {
            font-size: 1rem;
        }
        
        /* Image Gallery */
        .image-gallery {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .image-placeholder {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        .image-placeholder .material-symbols-outlined {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .image-info {
            padding: 0.75rem;
        }
        
        .image-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .image-tip {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
    </style>
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">ç·Šä¿‚ç·Š......ç·Šä¿‚åº¦ç·Šä¿‚åº¦ç”Ÿæˆç·Šä¿‚åº¦åº¦...</p>
    </div>

    <div class="page-container" id="mainContent" style="display: none;">
        <!-- Header -->
        <header class="header">
            <a href="/dashboard" class="back-btn">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <h1 class="page-title" id="pageTitle">{{ topic.title }}</h1>
            <div class="header-actions">
                <button class="regenerate-btn" onclick="regenerateContent()" id="regenerateBtn">
                    <span class="spinner"></span>
                    <span class="material-symbols-outlined">autorenew</span>
                    <span>é‡æ–°ç”Ÿæˆ</span>
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- Error State -->
            <div class="error-state" id="errorState" style="display: none;">
                <span class="material-symbols-outlined">error</span>
                <p id="errorMessage">è¼‰å…¥å¤±æ•—</p>
                <button class="btn-primary" onclick="loadContent()">é‡è©¦</button>
            </div>

            <!-- Content -->
            <div id="lessonContent" style="display: none;">
                <!-- Teaching Goal -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-icon" style="background: #dbeafe; color: #3b82f6;">
                            <span class="material-symbols-outlined" style="font-size: 1.25rem;">flag</span>
                        </div>
                        <h2 class="section-title">æ•™å­¸ç›®æ¨™</h2>
                    </div>
                    <div class="section-content">
                        <p id="teachingGoal">è¼‰å…¥ä¸­...</p>
                    </div>
                </section>

                <!-- Audio Section -->
                <section class="section audio-section" id="audioSection" style="display: none;">
                    <div class="audio-card">
                        <div class="audio-header">
                            <div class="audio-title">
                                <span class="audio-label">ç²µèªæœ—è®€</span>
                                <span class="audio-length" id="audioLength"></span>
                            </div>
                            <button class="audio-play-btn" onclick="toggleAudio('cantonese')" id="cantonesePlayBtn">
                                <span class="material-symbols-outlined" id="cantonesePlayIcon">play_arrow</span>
                            </button>
                        </div>
                        <!-- Audio Player -->
                        <audio id="cantoneseAudio" style="display: none;" controls>
                            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³é »æ’­æ”¾
                        </audio>
                    </div>
                    
                    <!-- Coming Soon Badge -->
                    <div class="coming-soon-badge" id="mandarinComingSoon" style="display: none;">
                        <span class="material-symbols-outlined">schedule</span>
                        æ™®é€šè©±å³å°‡æ¨å‡º
                    </div>
                </section>

                <!-- Parent's Script -->
                <section class="section">
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <div class="accordion-title-group">
                                <div class="accordion-icon" style="background: #dcfce7; color: #22c55e;">
                                    <span class="material-symbols-outlined" style="font-size: 1.25rem;">record_voice_over</span>
                                </div>
                                <span class="accordion-title">å®¶é•·è©±è¡“</span>
                            </div>
                            <span class="material-symbols-outlined accordion-toggle">expand_more</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-inner">
                                <div class="script-box" id="parentScript">
                                    è¼‰å…¥ä¸­...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sample Questions -->
                <section class="section">
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <div class="accordion-title-group">
                                <div class="accordion-icon" style="background: #fef3c7; color: #f59e0b;">
                                    <span class="material-symbols-outlined" style="font-size: 1.25rem;">help</span>
                                </div>
                                <span class="accordion-title">ç¤ºä¾‹é¡Œç›®</span>
                            </div>
                            <span class="material-symbols-outlined accordion-toggle">expand_more</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-inner">
                                <ul class="accordion-list" id="sampleQuestions">
                                    <!-- Populated by JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Model Answer -->
                <section class="section">
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <div class="accordion-title-group">
                                <div class="accordion-icon" style="background: #f3e8ff; color: #a855f7;">
                                    <span class="material-symbols-outlined" style="font-size: 1.25rem;">lightbulb</span>
                                </div>
                                <span class="accordion-title">ç¤ºç¯„ç­”æ¡ˆ</span>
                            </div>
                            <span class="material-symbols-outlined accordion-toggle">expand_more</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-inner">
                                <div class="answer-block" id="modelAnswer">
                                    è¼‰å…¥ä¸­...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tips -->
                <section class="section">
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <div class="accordion-title-group">
                                <div class="accordion-icon" style="background: #fee2e2; color: #ef4444;">
                                    <span class="material-symbols-outlined" style="font-size: 1.25rem;">tips</span>
                                </div>
                                <span class="accordion-title">ç­”é¡ŒæŠ€å·§</span>
                            </div>
                            <span class="material-symbols-outlined accordion-toggle">expand_more</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-inner">
                                <ul class="accordion-list" id="tips">
                                    <!-- Populated by JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Images -->
                <section class="section" id="imageSection" style="display: none;">
                    <div class="section-header">
                        <div class="section-icon" style="background: #e0e7ff; color: #6366f1;">
                            <span class="material-symbols-outlined" style="font-size: 1.25rem;">image</span>
                        </div>
                        <h2 class="section-title">æ•™å­¸åœ–ç‰‡</h2>
                    </div>
                    <div class="image-gallery" id="imageGallery">
                        <!-- Populated by JS -->
                    </div>
                    <div class="image-nav" id="imageNav" style="display: none;">
                        <button class="image-nav-btn" onclick="prevImage()">
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <span class="image-counter" id="imageCounter">1 / 3</span>
                        <button class="image-nav-btn" onclick="nextImage()">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                    </div>
                </section>

                <!-- Generation Info -->
                <section class="section" id="genInfoSection" style="display: none;">
                    <div class="gen-info">
                        <span class="material-symbols-outlined" style="font-size: 0.875rem;">schedule</span>
                        <span id="genTime">ç”Ÿæˆæ™‚é–“: --</span>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-actions">
                <button class="btn-primary" onclick="markComplete()">
                    <span class="material-symbols-outlined">check_circle</span>
                    å®Œæˆç·´ç¿’
                </button>
            </div>
        </footer>
    </div>

    <script>
        // Configuration
        const TOPIC_ID = '{{ topic.id }}';
        
        // State
        let currentContent = null;
        let isLoading = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadContent();
        });

        // Load content from API
        async function loadContent(forceRegenerate = false) {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        topic: TOPIC_ID,
                        force_regenerate: forceRegenerate
                    })
                });

                const data = await response.json();

                if (response.ok && data.content) {
                    currentContent = data;
                    renderContent(data);
                    showContent();
                } else {
                    showError(data.message || 'è¼‰å…¥å¤±æ•—');
                }
            } catch (error) {
                console.error('Error loading content:', error);
                showError('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹é‡è©¦');
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }

        // Regenerate content
        function regenerateContent() {
            if (isLoading) return;
            
            const btn = document.getElementById('regenerateBtn');
            btn.classList.add('loading');
            btn.querySelector('span:last-child').textContent = 'ç·Šä¿‚åº¦...';
            
            loadContent(true).finally(() => {
                btn.classList.remove('loading');
                btn.querySelector('span:last-child').textContent = 'é‡æ–°ç”Ÿæˆ';
            });
        }

        // Render content to DOM
        function renderContent(data) {
            const content = data.content;
            
            // Teaching Goal
            document.getElementById('teachingGoal').textContent = content.teaching_goal || '';
            
            // Parent Script
            document.getElementById('parentScript').textContent = content.parent_script || '';
            
            // Sample Questions
            const questionsList = document.getElementById('sampleQuestions');
            questionsList.innerHTML = '';
            if (content.sample_questions) {
                content.sample_questions.forEach((q, i) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="bullet"></span><span>${i + 1}. ${q}</span>`;
                    questionsList.appendChild(li);
                });
            }
            
            // Model Answer
            document.getElementById('modelAnswer').textContent = content.model_answer || '';
            
            // Tips
            const tipsList = document.getElementById('tips');
            tipsList.innerHTML = '';
            if (content.tips) {
                content.tips.forEach((tip, i) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="bullet"></span><span>${i + 1}. ${tip}</span>`;
                    tipsList.appendChild(li);
                });
            }
            
            // Generation Info
            if (data.generation_time_ms) {
                document.getElementById('genInfoSection').style.display = 'block';
                document.getElementById('genTime').textContent = 
                    `ç”Ÿæˆæ™‚é–“: ${(data.generation_time_ms / 1000).toFixed(1)}ç§’`;
            }
            
            // Render audio section
            const audioSection = document.getElementById('audioSection');
            const mandarinBadge = document.getElementById('mandarinComingSoon');
            
            if (data.audio && data.audio.cantonese_url) {
                // Audio is ready
                audioSection.style.display = 'block';
                mandarinBadge.style.display = 'none';
                
                // Setup audio player
                const audio = document.getElementById('cantoneseAudio');
                audio.src = data.audio.cantonese_url;
                audio.onloadedmetadata = () => {
                    document.getElementById('audioLength').textContent = 
                        `${Math.floor(audio.duration / 60)}:${String(Math.floor(audio.duration % 60)).padStart(2, '0')}`;
                };
            } else if (data.audio_status && data.audio_status.cantonese === 'pending') {
                // Audio is being generated
                audioSection.style.display = 'block';
                document.getElementById('audioLength').textContent = 'ç·Šä¿‚åº¦ç”Ÿæˆç·Šä¿‚...';
                mandarinBadge.style.display = 'none';
            } else {
                // Audio not available
                audioSection.style.display = 'none';
                mandarinBadge.style.display = 'flex';
            }
            
            // Render images
            renderImages(data.images || []);
        }

        // Render images
        function renderImages(images) {
            const imageSection = document.getElementById('imageSection');
            const gallery = document.getElementById('imageGallery');
            
            if (!images || images.length === 0) {
                imageSection.style.display = 'none';
                return;
            }
            
            imageSection.style.display = 'block';
            gallery.innerHTML = '';
            
            images.forEach((img, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                
                card.innerHTML = `
                    <div class="image-placeholder">
                        <span class="material-symbols-outlined">image</span>
                        <span>${img.name || 'æ•™å­¸åœ–ç‰‡'}</span>
                    </div>
                    <div class="image-info">
                        <div class="image-name">${index + 1}. ${img.name || 'åœ–ç‰‡'}</div>
                        ${img.description ? `<div class="image-tip">${img.description}</div>` : ''}
                    </div>
                `;
                
                gallery.appendChild(card);
            });
        }

        // UI Helpers
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showContent() {
            document.getElementById('lessonContent').style.display = 'block';
            document.getElementById('mainContent').style.display = 'flex';
        }

        function showError(message) {
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function hideError() {
            document.getElementById('errorState').style.display = 'none';
        }

        // Accordion toggle
        function toggleAccordion(header) {
            const accordion = header.parentElement;
            const wasOpen = accordion.classList.contains('open');

            document.querySelectorAll('.accordion').forEach(acc => {
                acc.classList.remove('open');
            });

            if (!wasOpen) {
                accordion.classList.add('open');
            }
        }

        // Audio player
        let currentAudio = null;
        
        function toggleAudio(language) {
            const audio = document.getElementById('cantoneseAudio');
            const icon = document.getElementById('cantonesePlayIcon');
            
            if (!audio.src || audio.src === window.location.href) {
                // No audio available
                alert('èªéŸ³åŠŸèƒ½å³å°‡æ¨å‡ºï¼');
                return;
            }
            
            if (audio.paused) {
                audio.play();
                icon.textContent = 'pause';
            } else {
                audio.pause();
                icon.textContent = 'play_arrow';
            }
            
            audio.onended = () => {
                icon.textContent = 'play_arrow';
            };
        }

        // Mark as complete
        function markComplete() {
            alert('ç·´ç¿’å®Œæˆï¼ğŸ‰ è¨˜å¾—è¦æ¯”å•±å””å¥½è¦ä¿¾çˆ¸çˆ¸åª½å’ªç‡å“ï½');
        }
    </script>
</body>
</html>
