<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日任务 - AI Tutor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90d9;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f8f9fa;
        }
        .header-section {
            background: linear-gradient(135deg, var(--success-color), #00cec9);
            color: white;
            padding: 40px 0;
        }
        .task-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
        }
        .task-card:hover {
            transform: translateX(5px);
        }
        .task-card.pending {
            border-left-color: var(--warning-color);
        }
        .task-card.in_progress {
            border-left-color: var(--primary-color);
        }
        .task-card.completed {
            border-left-color: var(--success-color);
            opacity: 0.8;
        }
        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .task-icon.lesson { background: #e8f4fd; color: var(--primary-color); }
        .task-icon.quick { background: #fff3cd; color: #856404; }
        .task-icon.voice { background: #e8e8f6; color: #6c5ce7; }
        .task-icon.scenario { background: #d4edda; color: #155724; }

        .difficulty-badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .difficulty-easy { background: #d4edda; color: #155724; }
        .difficulty-medium { background: #fff3cd; color: #856404; }
        .difficulty-hard { background: #f8d7da; color: #721c24; }

        .streak-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/dashboard">
                <i class="bi bi-robot me-2"></i>AI Tutor
            </a>
            <div class="d-flex gap-2">
                <a href="/micro-lessons" class="btn btn-outline-primary">微课工坊</a>
                <a href="/practice" class="btn btn-outline-primary">练习中心</a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4 fw-bold mb-2">每日学习任务</h1>
                    <p class="lead mb-0">完成每日任务，获得更多积分！</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="streak-badge d-inline-block">
                        <i class="bi bi-fire me-2"></i>
                        <span class="h3 mb-0" id="streakDays">0</span> 天连续学习
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Selector -->
    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-secondary" onclick="changeDate(-1)">
                <i class="bi bi-chevron-left"></i> 昨天
            </button>
            <h4 id="currentDate" class="mb-0">今天</h4>
            <button class="btn btn-outline-secondary" onclick="changeDate(1)">
                明天 <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Tasks Container -->
    <div class="container pb-5">
        <div class="row">
            <div class="col-lg-8">
                <h4 class="mb-3">学习任务</h4>
                <div id="tasksContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">加载任务中...</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Summary Card -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">今日进度</h5>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>已完成</span>
                                <span id="completedCount">0 / 0</span>
                            </div>
                            <div class="progress" style="height: 12px;">
                                <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 text-primary mb-0" id="totalPoints">0</div>
                                <small class="text-muted">获得积分</small>
                            </div>
                            <div class="text-end">
                                <div class="h4 text-warning mb-0" id="remainingPoints">0</div>
                                <small class="text-muted">剩余积分</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">快速开始</h5>
                        <div class="d-grid gap-2">
                            <a href="/practice/quick/general" class="btn btn-warning text-white">
                                <i class="bi bi-lightning me-2"></i>快速问答
                            </a>
                            <a href="/practice/voice/0" class="btn btn-primary">
                                <i class="bi bi-mic me-2"></i>语音跟读
                            </a>
                            <a href="/micro-lessons" class="btn btn-success">
                                <i class="bi bi-play-circle me-2"></i>观看微课
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDate = new Date();
        let currentTasks = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            updateDateDisplay();
        });

        function loadTasks() {
            const dateStr = currentDate.toISOString().split('T')[0];
            fetch(`/api/daily-tasks?date=${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentTasks = data.tasks || [];
                        renderTasks(currentTasks);
                        updateSummary(currentTasks);
                    }
                })
                .catch(error => {
                    console.error('Error loading tasks:', error);
                });
        }

        function renderTasks(tasks) {
            const container = document.getElementById('tasksContainer');

            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-calendar-check display-1 text-muted"></i>
                        <h4 class="mt-3">暂无任务</h4>
                        <p class="text-muted">今天还没有任务</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-card ${task.status}">
                    <div class="d-flex align-items-center">
                        <div class="task-icon ${getTaskIconClass(task.task_type)} me-3">
                            ${getTaskIcon(task.task_type)}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-1">${task.task_title}</h5>
                                    <p class="text-muted mb-1">${task.task_description || ''}</p>
                                    <div class="d-flex gap-2 align-items-center">
                                        <span class="difficulty-badge difficulty-${task.difficulty}">${getDifficultyText(task.difficulty)}</span>
                                        <small class="text-muted"><i class="bi bi-clock me-1"></i>${task.duration_seconds}秒</small>
                                        <small class="text-warning"><i class="bi bi-star-fill me-1"></i>+${task.points}分</small>
                                    </div>
                                </div>
                                <div>
                                    ${renderTaskAction(task)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTaskAction(task) {
            if (task.status === 'completed') {
                return '<span class="badge bg-success"><i class="bi bi-check-circle"></i> 已完成</span>';
            } else if (task.status === 'in_progress') {
                return `<button class="btn btn-primary btn-sm" onclick="continueTask(${task.id}, '${task.task_type}')">继续</button>`;
            } else {
                return `<button class="btn btn-primary btn-sm" onclick="startTask(${task.id}, '${task.task_type}')">开始</button>`;
            }
        }

        function startTask(taskId, taskType) {
            // Mark as in_progress
            completeTask(taskId, null, true);

            // Redirect to appropriate practice
            if (taskType === 'micro_lesson') {
                window.location.href = '/micro-lessons';
            } else if (taskType === 'quick_practice') {
                window.location.href = '/practice/quick/general';
            } else if (taskType === 'voice_repeat') {
                window.location.href = '/practice/voice/0';
            } else if (taskType === 'scenario_simulation') {
                // Trigger scenario practice
                window.location.href = '/micro-lessons';
            }
        }

        function continueTask(taskId, taskType) {
            startTask(taskId, taskType);
        }

        function completeTask(taskId, score, markInProgress = false) {
            const endpoint = markInProgress
                ? `/api/daily-tasks/start`
                : `/api/daily-tasks/complete`;

            fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    task_id: taskId,
                    score: score
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTasks();
                }
            })
            .catch(console.error);
        }

        function updateSummary(tasks) {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const totalPoints = tasks.filter(t => t.status === 'completed').reduce((sum, t) => sum + (t.points || 0), 0);
            const remainingPoints = tasks.reduce((sum, t) => sum + (t.points || 0), 0) - totalPoints;

            document.getElementById('completedCount').textContent = `${completed} / ${total}`;
            document.getElementById('progressBar').style.width = `${total > 0 ? (completed / total) * 100 : 0}%`;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('remainingPoints').textContent = remainingPoints;
        }

        function changeDate(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            updateDateDisplay();
            loadTasks();
        }

        function updateDateDisplay() {
            const today = new Date();
            const diff = Math.floor((currentDate - today) / (1000 * 60 * 60 * 24));

            let text = '';
            if (diff === 0) text = '今天';
            else if (diff === -1) text = '昨天';
            else if (diff === 1) text = '明天';
            else text = currentDate.toLocaleDateString('zh-CN', {month: 'long', day: 'numeric'});

            document.getElementById('currentDate').textContent = text;
        }

        function getTaskIcon(taskType) {
            const icons = {
                'micro_lesson': '<i class="bi bi-play-circle"></i>',
                'quick_practice': '<i class="bi bi-lightning"></i>',
                'voice_repeat': '<i class="bi bi-mic"></i>',
                'scenario_simulation': '<i class="bi bi-chat-dots"></i>'
            };
            return icons[taskType] || '<i class="bi bi-trophy"></i>';
        }

        function getTaskIconClass(taskType) {
            const classes = {
                'micro_lesson': 'lesson',
                'quick_practice': 'quick',
                'voice_repeat': 'voice',
                'scenario_simulation': 'scenario'
            };
            return classes[taskType] || 'lesson';
        }

        function getDifficultyText(difficulty) {
            const map = {'easy': '简单', 'medium': '中等', 'hard': '困难'};
            return map[difficulty] || difficulty;
        }
    </script>
</body>
</html>
