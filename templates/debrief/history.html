{% extends "base.html" %}

{% block title %}å†å²å¤ç›˜è®°å½•{% endblock %}

{% block extra_head %}
<style>
    .history-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem 1rem;
        text-align: center;
        border-radius: 0 0 20px 20px;
    }

    .back-btn {
        position: absolute;
        left: 1rem;
        top: 1.5rem;
        color: white;
        text-decoration: none;
        font-size: 1.5rem;
    }

    .filter-tabs {
        display: flex;
        padding: 1rem;
        gap: 0.5rem;
    }

    .filter-tab {
        flex: 1;
        padding: 0.5rem;
        text-align: center;
        border-radius: 20px;
        background: #f0f0f0;
        color: #666;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-tab.active {
        background: #667eea;
        color: white;
    }

    .sessions-list {
        padding: 0 1rem;
    }

    .session-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .session-card:hover {
        transform: translateY(-2px);
    }

    .session-score {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 700;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .score-high { background: #d4edda; color: #155724; }
    .score-medium { background: #fff3cd; color: #856404; }
    .score-low { background: #f8d7da; color: #721c24; }

    .session-info {
        flex: 1;
    }

    .session-info .date {
        font-size: 0.85rem;
        color: #666;
    }

    .session-info .type {
        font-weight: 500;
        margin: 0.25rem 0;
    }

    .session-info .details {
        font-size: 0.8rem;
        color: #999;
    }

    .session-arrow {
        color: #999;
        font-size: 1.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #999;
    }

    .empty-state .icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .pagination {
        display: flex;
        justify-content: center;
        padding: 1rem;
        gap: 0.5rem;
    }

    .pagination button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }

    .pagination button.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="history-header">
    <a href="{{ url_for('debrief_index') }}" class="back-btn">â€¹</a>
    <h1>å†å²å¤ç›˜è®°å½•</h1>
    <p>æŸ¥çœ‹æ‰€æœ‰é¢è¯•å¤ç›˜</p>
</div>

<div class="filter-tabs">
    <div class="filter-tab active" data-filter="all">å…¨éƒ¨</div>
    <div class="filter-tab" data-filter="completed">å·²å®Œæˆ</div>
    <div class="filter-tab" data-filter="week">æœ¬å‘¨</div>
    <div class="filter-tab" data-filter="month">æœ¬æœˆ</div>
</div>

<div class="sessions-list" id="sessionsList">
    <div class="empty-state">
        <div class="icon">ğŸ“‹</div>
        <p>æš‚æ— å¤ç›˜è®°å½•</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    loadHistory();

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            loadHistory();
        });
    });
});

async function loadHistory() {
    try {
        let url = '/api/debrief/sessions?limit=50';
        if (currentFilter === 'completed') {
            url += '&status=completed';
        }

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            let sessions = data.sessions || [];

            // Filter by week/month if needed
            if (currentFilter === 'week') {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                sessions = sessions.filter(s => new Date(s.created_at) >= weekAgo);
            } else if (currentFilter === 'month') {
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                sessions = sessions.filter(s => new Date(s.created_at) >= monthAgo);
            }

            renderSessions(sessions);
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

function renderSessions(sessions) {
    const container = document.getElementById('sessionsList');

    if (!sessions || sessions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="icon">ğŸ“‹</div>
                <p>æš‚æ— å¤ç›˜è®°å½•</p>
            </div>
        `;
        return;
    }

    container.innerHTML = sessions.map(session => {
        const score = session.overall_score || 0;
        const scoreClass = score >= 75 ? 'score-high' : (score >= 60 ? 'score-medium' : 'score-low');
        const date = new Date(session.created_at).toLocaleDateString('zh-HK', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        const duration = Math.round((session.duration_seconds || 0) / 60);

        return `
            <div class="session-card" onclick="window.location.href='/debrief/session/${session.id}'">
                <div class="session-score ${scoreClass}">${score}</div>
                <div class="session-info">
                    <div class="type">${session.school_type || 'æ¨¡æ‹Ÿé¢è¯•'}</div>
                    <div class="date">${date}</div>
                    <div class="details">${session.total_questions || 0}ä¸ªé—®é¢˜ Â· ${duration}åˆ†é’Ÿ</div>
                </div>
                <span class="session-arrow">â€º</span>
            </div>
        `;
    }).join('');
}
</script>
{% endblock %}
