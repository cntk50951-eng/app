{% extends "base.html" %}

{% block title %}å†å²å¯¹æ¯”åˆ†æ{% endblock %}

{% block extra_head %}
<style>
    .compare-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem 1rem;
        text-align: center;
        border-radius: 0 0 20px 20px;
    }

    .back-btn {
        position: absolute;
        left: 1rem;
        top: 1.5rem;
        color: white;
        text-decoration: none;
        font-size: 1.5rem;
    }

    .trend-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .trend-icon {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    .trend-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .trend-description {
        color: #666;
        font-size: 0.9rem;
    }

    .trend-change {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }

    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-stable { color: #ffc107; }

    .chart-container {
        background: white;
        border-radius: 12px;
        margin: 1rem;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .line-chart {
        height: 200px;
        position: relative;
    }

    .chart-point {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #667eea;
        transform: translate(-50%, 50%);
    }

    .chart-line {
        position: absolute;
        height: 2px;
        background: #667eea;
        transform-origin: left center;
    }

    .dimensions-comparison {
        background: white;
        border-radius: 12px;
        margin: 1rem;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .dimension-row {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .dimension-name {
        width: 80px;
        font-size: 0.85rem;
        color: #666;
    }

    .dimension-bar-container {
        flex: 1;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 0 0.5rem;
    }

    .dimension-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .dimension-value {
        width: 40px;
        text-align: right;
        font-weight: 600;
    }

    .highlights-list {
        background: white;
        border-radius: 12px;
        margin: 1rem;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .highlight-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .highlight-item:last-child {
        border-bottom: none;
    }

    .highlight-icon {
        font-size: 1.5rem;
        margin-right: 0.75rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #999;
    }

    .empty-state .icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="compare-header">
    <a href="{{ url_for('debrief_index') }}" class="back-btn">â€¹</a>
    <h1>å†å²å¯¹æ¯”åˆ†æ</h1>
    <p>äº†è§£ä½ çš„è¿›æ­¥è¶‹åŠ¿</p>
</div>

<div id="compareContent">
    <div class="trend-card">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadComparison();
});

async function loadComparison() {
    try {
        const response = await fetch('/api/debrief/compare');
        const data = await response.json();

        if (data.success && data.comparison) {
            renderComparison(data.comparison);
        } else {
            renderEmpty();
        }
    } catch (error) {
        console.error('Error loading comparison:', error);
        renderEmpty();
    }
}

function renderComparison(comparison) {
    const container = document.getElementById('compareContent');

    // Trend card
    let trendIcon = 'ğŸ“ˆ';
    let trendClass = 'trend-up';
    let trendText = 'è¿›æ­¥ä¸­';

    if (comparison.trend === 'improving') {
        trendIcon = 'ğŸš€';
        trendClass = 'trend-up';
        trendText = 'æ˜æ˜¾è¿›æ­¥';
    } else if (comparison.trend === 'slight_improvement') {
        trendIcon = 'ğŸ“ˆ';
        trendClass = 'trend-up';
        trendText = 'è½»å¾®è¿›æ­¥';
    } else if (comparison.trend === 'declining') {
        trendIcon = 'ğŸ“‰';
        trendClass = 'trend-down';
        trendText = 'éœ€è¦åŠ æ²¹';
    } else if (comparison.trend === 'stable') {
        trendIcon = 'â¡ï¸';
        trendClass = 'trend-stable';
        trendText = 'è¡¨ç°ç¨³å®š';
    }

    const scoreChange = comparison.score_change || 0;
    const changeClass = scoreChange > 0 ? 'trend-up' : (scoreChange < 0 ? 'trend-down' : 'trend-stable');

    container.innerHTML = `
        <div class="trend-card">
            <div class="trend-icon">${trendIcon}</div>
            <div class="trend-title">${trendText}</div>
            <div class="trend-change ${changeClass}">${scoreChange > 0 ? '+' : ''}${scoreChange}åˆ†</div>
            <div class="trend-description">${comparison.insight || ''}</div>
        </div>

        <div class="chart-container">
            <div class="chart-title">åˆ†æ•°è¶‹åŠ¿</div>
            <div class="line-chart" id="scoreChart">
                <!-- Chart will be rendered here -->
            </div>
        </div>

        <div class="highlights-list">
            <div class="chart-title">äº®ç‚¹ç»Ÿè®¡</div>
            ${(comparison.highlights || []).map(h => `
                <div class="highlight-item">
                    <span class="highlight-icon">â­</span>
                    <span>${h}</span>
                </div>
            `).join('')}
            <div class="highlight-item">
                <span class="highlight-icon">ğŸ“Š</span>
                <span>å…±${comparison.total_sessions || 0}æ¬¡å¤ç›˜è®°å½•</span>
            </div>
        </div>

        <div class="dimensions-comparison">
            <div class="chart-title">èƒ½åŠ›ç»´åº¦åˆ†å¸ƒ</div>
            ${renderDimensions()}
        </div>
    `;

    // Render chart
    renderChart(comparison.scores_over_time || []);
}

function renderDimensions() {
    const dimensions = [
        { name: 'é€»è¾‘æ€§', value: 75 },
        { name: 'å®Œæ•´æ€§', value: 72 },
        { name: 'åˆ›æ–°æ€§', value: 68 },
        { name: 'ç›¸å…³æ€§', value: 82 },
        { name: 'æ¸…æ™°åº¦', value: 85 },
        { name: 'æµç•…åº¦', value: 78 }
    ];

    return dimensions.map(dim => `
        <div class="dimension-row">
            <div class="dimension-name">${dim.name}</div>
            <div class="dimension-bar-container">
                <div class="dimension-bar" style="width: ${dim.value}%"></div>
            </div>
            <div class="dimension-value">${dim.value}</div>
        </div>
    `).join('');
}

function renderChart(scores) {
    const container = document.getElementById('scoreChart');

    if (!scores || scores.length < 2) {
        container.innerHTML = '<p style="text-align:center;color:#999">æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆè¶‹åŠ¿å›¾</p>';
        return;
    }

    const maxScore = 100;
    const minScore = 0;
    const height = 180;
    const width = 320;
    const padding = 20;

    const points = scores.map((s, i) => {
        const x = padding + (i / (scores.length - 1)) * (width - 2 * padding);
        const y = height - padding - ((s.score - minScore) / (maxScore - minScore)) * (height - 2 * padding);
        return { x, y, score: s.score, date: s.date };
    });

    let html = '';
    // Draw line
    for (let i = 0; i < points.length - 1; i++) {
        const p1 = points[i];
        const p2 = points[i + 1];
        const length = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
        const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;

        html += `<div class="chart-line" style="
            left: ${p1.x}px;
            top: ${p1.y}px;
            width: ${length}px;
            transform: rotate(${angle}deg);
        "></div>`;
    }

    // Draw points
    points.forEach(p => {
        html += `<div class="chart-point" style="left: ${p.x}px; top: ${p.y}px;" title="${p.score}åˆ†"></div>`;
    });

    container.innerHTML = html;
}

function renderEmpty() {
    const container = document.getElementById('compareContent');
    container.innerHTML = `
        <div class="empty-state">
            <div class="icon">ğŸ“Š</div>
            <p>æ•°æ®ä¸è¶³ï¼Œéœ€è¦æ›´å¤šå¤ç›˜è®°å½•æ¥åˆ†æè¶‹åŠ¿</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem;">å®Œæˆè‡³å°‘2æ¬¡é¢è¯•å¤ç›˜åå³å¯æŸ¥çœ‹å¯¹æ¯”åˆ†æ</p>
        </div>
    `;
}
</script>
{% endblock %}
