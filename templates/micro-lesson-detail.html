<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微课详情 - AI Tutor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90d9;
            --secondary-color: #6c5ce7;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f8f9fa;
        }
        .lesson-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 40px 0;
        }
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-top: -30px;
        }
        .key-point {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }
        .progress-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--primary-color) 0%, #e9ecef 0%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-ring-inner {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/dashboard">
                <i class="bi bi-robot me-2"></i>AI Tutor
            </a>
            <a class="btn btn-outline-primary" href="/micro-lessons">
                <i class="bi bi-arrow-left me-2"></i>返回微课列表
            </a>
        </div>
    </nav>

    <!-- Lesson Header -->
    <div class="lesson-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="/micro-lessons" class="text-white-50">微课工坊</a></li>
                            <li class="breadcrumb-item active text-white" id="lessonTitle">加载中...</li>
                        </ol>
                    </nav>
                    <h1 class="display-5 fw-bold" id="titleDisplay">微课详情</h1>
                    <p class="lead" id="descriptionDisplay">...</p>
                    <div class="d-flex gap-3 mt-3">
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-clock me-1"></i><span id="durationDisplay">0</span>秒
                        </span>
                        <span class="badge bg-light text-dark" id="difficultyBadge">难度</span>
                        <span class="badge bg-light text-dark" id="topicBadge">主题</span>
                    </div>
                </div>
                <div class="col-lg-4 text-center">
                    <div class="progress-ring" id="progressRing">
                        <div class="progress-ring-inner">
                            <span class="h4 mb-0" id="progressPercent">0%</span>
                            <small class="text-muted">完成度</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="container my-5">
        <div class="row">
            <div class="col-lg-8">
                <div class="content-card mb-4">
                    <h4 class="mb-4">
                        <i class="bi bi-book me-2 text-primary"></i>课程内容
                    </h4>
                    <div id="lessonContent" class="lesson-content" style="font-size: 18px; line-height: 1.8;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3">加载内容中...</p>
                        </div>
                    </div>
                </div>

                <div class="content-card mb-4">
                    <h4 class="mb-4">
                        <i class="bi bi-lightbulb me-2 text-warning"></i>关键要点
                    </h4>
                    <div id="keyPoints">
                        <!-- Key points will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="content-card mb-4">
                    <h5 class="mb-3">学习进度</h5>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>当前进度</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">已学习时间</label>
                        <div class="fs-4 text-primary" id="timeSpent">0 秒</div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="updateProgress()">
                        <i class="bi bi-check-circle me-2"></i>完成学习
                    </button>
                </div>

                <div class="content-card mb-4">
                    <h5 class="mb-3">相关练习</h5>
                    <div class="d-grid gap-2">
                        <a href="/practice/quick/general" class="btn btn-outline-primary">
                            <i class="bi bi-lightning me-2"></i>快速问答
                        </a>
                        <a href="#" class="btn btn-outline-success" onclick="startVoicePractice()">
                            <i class="bi bi-mic me-2"></i>语音跟读
                        </a>
                    </div>
                </div>

                <div class="content-card">
                    <h5 class="mb-3">课程信息</h5>
                    <ul class="list-unstyled text-muted">
                        <li class="mb-2"><i class="bi bi-calendar me-2"></i>创建时间: <span id="createdAt">-</span></li>
                        <li class="mb-2"><i class="bi bi-eye me-2"></i>阅读次数: <span id="viewCount">0</span></li>
                        <li><i class="bi bi-heart me-2"></i>点赞次数: <span id="likeCount">0</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const lessonId = {{ lesson_id }};

        // Load lesson on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadLessonDetail();
        });

        function loadLessonDetail() {
            fetch(`/api/micro-lessons/${lessonId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderLesson(data.lesson);
                    } else {
                        alert('加载失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading lesson:', error);
                    document.getElementById('lessonContent').innerHTML = '<p class="text-danger">加载失败，请重试</p>';
                });
        }

        function renderLesson(lesson) {
            document.getElementById('lessonTitle').textContent = lesson.title;
            document.getElementById('titleDisplay').textContent = lesson.title;
            document.getElementById('descriptionDisplay').textContent = lesson.description || '';

            document.getElementById('durationDisplay').textContent = lesson.duration_seconds || 60;
            document.getElementById('difficultyBadge').textContent = getDifficultyText(lesson.difficulty);
            document.getElementById('topicBadge').textContent = lesson.topic || '通用';

            // Content
            document.getElementById('lessonContent').innerHTML = lesson.content || '暂无内容';

            // Key points
            const keyPointsDiv = document.getElementById('keyPoints');
            if (lesson.key_points && lesson.key_points.length > 0) {
                keyPointsDiv.innerHTML = lesson.key_points.map((point, i) => `
                    <div class="key-point">
                        <strong>要点 ${i + 1}:</strong> ${point}
                    </div>
                `).join('');
            } else {
                keyPointsDiv.innerHTML = '<p class="text-muted">暂无要点</p>';
            }

            // Dates and counts
            document.getElementById('createdAt').textContent = formatDate(lesson.created_at);
            document.getElementById('viewCount').textContent = lesson.view_count || 0;
            document.getElementById('likeCount').textContent = lesson.like_count || 0;

            // Update progress ring
            updateProgressUI(0);
        }

        function updateProgress() {
            fetch(`/api/micro-lessons/${lessonId}/progress`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    progress_percent: 100,
                    time_spent: 60
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateProgressUI(100);
                    alert('恭喜完成学习！');
                }
            })
            .catch(console.error);
        }

        function updateProgressUI(percent) {
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
            document.getElementById('timeSpent').textContent = Math.round(percent * 0.6) + ' 秒';

            document.getElementById('progressRing').style.background =
                `conic-gradient(var(--primary-color) ${percent}%, #e9ecef ${percent}%)`;
        }

        function startVoicePractice() {
            window.location.href = `/practice/voice/${lessonId}`;
        }

        function getDifficultyText(difficulty) {
            const map = {'easy': '简单', 'medium': '中等', 'hard': '困难'};
            return map[difficulty] || difficulty;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }
    </script>
</body>
</html>
