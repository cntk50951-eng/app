<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>面试报告 - AI Tutor</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        body {
            min-height: max(884px, 100dvh);
            background: var(--background-light);
        }

        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            padding-bottom: 0.5rem;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-btn {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s ease;
            text-decoration: none;
            color: var(--text-primary);
        }

        .back-btn:hover {
            background: var(--background-light);
        }

        .page-title {
            flex: 1;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-right: 2.5rem;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 1.5rem 6rem;
        }

        /* Hero Section */
        .hero-section {
            text-align: center;
            padding: 2rem 0;
        }

        .score-circle {
            width: 8rem;
            height: 8rem;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
        }

        .score-circle.excellent {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
        }

        .score-circle.good {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .score-circle.needs-practice {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
        }

        .score-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            line-height: 1;
        }

        .score-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.9);
            margin-top: 0.25rem;
        }

        .hero-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .hero-subtitle {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Info Card */
        .info-card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
        }

        .info-row:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .info-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .info-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        /* Questions Section */
        .questions-section {
            margin-top: 1.5rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .question-card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .question-category {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: var(--primary-50);
            color: var(--primary);
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .question-score {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .question-text {
            font-size: 0.9375rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .answer-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            background: var(--background-light);
            padding: 0.75rem;
            border-radius: var(--radius-lg);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .feedback-section {
            background: #f0fdf4;
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            border: 1px solid #bbf7d0;
        }

        .feedback-title {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #16a34a;
            margin-bottom: 0.5rem;
        }

        .feedback-text {
            font-size: 0.8125rem;
            color: #166534;
            line-height: 1.5;
        }

        .strengths-list {
            margin-top: 0.5rem;
        }

        .strength-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: #16a34a;
        }

        /* Actions */
        .actions-section {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .primary-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: var(--radius-xl);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.4);
        }

        .secondary-btn {
            width: 100%;
            padding: 1rem;
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: var(--radius-xl);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .secondary-btn:hover {
            background: var(--primary-50);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
            padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.625rem;
            font-weight: 500;
            transition: color 0.2s ease;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item .material-symbols-outlined {
            font-size: 1.5rem;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid var(--primary-50);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 1rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <header class="header">
            <a href="{{ url_for('dashboard') }}" class="back-btn">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <h1 class="page-title">面试报告</h1>
            <div style="width: 2.5rem;"></div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Hero Section -->
            <div class="hero-section">
                <div class="score-circle" id="score-circle">
                    <span class="score-value" id="score-value">0</span>
                    <span class="score-label">综合评分</span>
                </div>
                <h2 class="hero-title" id="hero-title">面试完成!</h2>
                <p class="hero-subtitle" id="hero-subtitle">继续努力，下次会做得更好!</p>
            </div>

            <!-- Info Card -->
            <div class="info-card">
                <div class="info-row">
                    <div class="info-label">
                        <span class="material-symbols-outlined" style="font-size: 1.25rem;">school</span>
                        学校类型
                    </div>
                    <div class="info-value" id="school-type">-</div>
                </div>
                <div class="info-row">
                    <div class="info-label">
                        <span class="material-symbols-outlined" style="font-size: 1.25rem;">person</span>
                        面试官风格
                    </div>
                    <div class="info-value" id="interviewer-style">-</div>
                </div>
                <div class="info-row" id="fright-row" style="display: none;">
                    <div class="info-label">
                        <span class="material-symbols-outlined" style="font-size: 1.25rem;">psychology</span>
                        怯场模式
                    </div>
                    <div class="info-value" id="fright-level">-</div>
                </div>
                <div class="info-row">
                    <div class="info-label">
                        <span class="material-symbols-outlined" style="font-size: 1.25rem;">help</span>
                        问题数量
                    </div>
                    <div class="info-value" id="question-count">-</div>
                </div>
                <div class="info-row">
                    <div class="info-label">
                        <span class="material-symbols-outlined" style="font-size: 1.25rem;">schedule</span>
                        完成时间
                    </div>
                    <div class="info-value" id="completed-time">-</div>
                </div>
            </div>

            <!-- Questions Section -->
            <div class="questions-section">
                <h3 class="section-title">
                    <span class="material-symbols-outlined">rate_review</span>
                    问题分析
                </h3>
                <div id="ai-evaluation" style="display: none;">
                    <!-- AI Evaluation will be loaded here -->
                </div>
                <div id="questions-list">
                    <!-- Questions will be loaded here -->
                </div>
            </div>

            <!-- Actions -->
            <div class="actions-section">
                <button class="primary-btn" onclick="retryInterview()">
                    <span class="material-symbols-outlined">replay</span>
                    再试一次
                </button>
                <button class="secondary-btn" onclick="shareResult()">
                    <span class="material-symbols-outlined">share</span>
                    分享结果
                </button>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item" onclick="window.location.href='{{ url_for('dashboard') }}'">
                <span class="material-symbols-outlined">dashboard</span>
                <span>首页</span>
            </div>
            <div class="nav-item" onclick="window.location.href='{{ url_for('parent_notes') }}'">
                <span class="material-symbols-outlined">note_add</span>
                <span>笔记</span>
            </div>
            <div class="nav-item" onclick="window.location.href='{{ url_for('settings') }}'">
                <span class="material-symbols-outlined">settings</span>
                <span>设置</span>
            </div>
        </nav>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">加载报告中...</div>
    </div>

    <script>
        const sessionId = '{{ session_id }}';

        // Load report data
        async function loadReport() {
            try {
                const response = await fetch(`/api/mock-interview/${sessionId}`);

                if (response.ok) {
                    const data = await response.json();
                    displayReport(data.session);
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error loading report:', error);
                showError();
            }
        }

        function displayReport(session) {
            // Update score
            const score = session.score || 0;
            const scoreValue = document.getElementById('score-value');
            const scoreCircle = document.getElementById('score-circle');
            const heroTitle = document.getElementById('hero-title');
            const heroSubtitle = document.getElementById('hero-subtitle');

            scoreValue.textContent = score;

            // Set score circle color based on score
            if (score >= 80) {
                scoreCircle.classList.add('excellent');
                heroTitle.textContent = '太棒了!';
                heroSubtitle.textContent = '表现非常优秀，继续保持!';
            } else if (score >= 60) {
                scoreCircle.classList.add('good');
                heroTitle.textContent = '做得不错!';
                heroSubtitle.textContent = '继续努力，会越来越好的!';
            } else {
                scoreCircle.classList.add('needs-practice');
                heroTitle.textContent = '面试完成!';
                heroSubtitle.textContent = '继续练习，下次会做得更好!';
            }

            // Update info
            document.getElementById('school-type').textContent = session.school_type_name || '-';
            document.getElementById('interviewer-style').textContent = session.interviewer_style_name || '亲和型';
            
            // Show/hide stage fright level
            const frightRow = document.getElementById('fright-row');
            if (session.stage_fright_level && session.stage_fright_level > 1) {
                frightRow.style.display = 'flex';
                document.getElementById('fright-level').textContent = `${session.stage_fright_name || '初阶'} (Level ${session.stage_fright_level})`;
            } else {
                frightRow.style.display = 'none';
            }
            
            document.getElementById('question-count').textContent = (session.evaluations || []).length || '-';
            document.getElementById('completed-time').textContent = session.created_at || '-';

            // Display questions
            const questionsList = document.getElementById('questions-list');
            const evaluations = session.evaluations || [];
            const aiEval = session.ai_evaluation;

            // Display AI evaluation if available
            const aiEvalSection = document.getElementById('ai-evaluation');
            if (aiEval) {
                aiEvalSection.style.display = 'block';
                
                const strengths = aiEval.strengths || [];
                const improvements = aiEval.improvements || [];
                const suggestions = aiEval.suggestions || [];
                
                let aiEvalHtml = `
                    <div class="question-card" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: none;">
                        <div class="question-header">
                            <div class="question-category" style="background: #6366f1; color: white;">
                                <span class="material-symbols-outlined" style="font-size: 0.875rem;">auto_awesome</span>
                                AI 智能评估
                            </div>
                        </div>
                        <div class="question-text" style="font-size: 1rem;">${aiEval.overall_summary || '继续努力！'}</div>
                `;
                
                if (strengths.length > 0) {
                    aiEvalHtml += `
                        <div class="feedback-section" style="background: #f0fdf4; border-color: #bbf7d0;">
                            <div class="feedback-title" style="color: #16a34a;">
                                <span class="material-symbols-outlined" style="font-size: 0.875rem;">thumb_up</span>
                                优势亮点
                            </div>
                            <div class="strengths-list">
                                ${strengths.map(s => `<div class="strength-item"><span class="material-symbols-outlined" style="font-size: 0.875rem;">check_circle</span>${s}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (improvements.length > 0) {
                    aiEvalHtml += `
                        <div class="feedback-section" style="background: #fef3c7; border-color: #fcd34d; margin-top: 0.75rem;">
                            <div class="feedback-title" style="color: #d97706;">
                                <span class="material-symbols-outlined" style="font-size: 0.875rem;">trending_up</span>
                                改进建议
                            </div>
                            <div class="strengths-list">
                                ${improvements.map(s => `<div class="strength-item"><span class="material-symbols-outlined" style="font-size: 0.875rem;">arrow_forward</span>${s}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (suggestions.length > 0) {
                    aiEvalHtml += `
                        <div class="feedback-section" style="background: #f0f9ff; border-color: #bae6fd; margin-top: 0.75rem;">
                            <div class="feedback-title" style="color: #0284c7;">
                                <span class="material-symbols-outlined" style="font-size: 0.875rem;">lightbulb</span>
                                练习建议
                            </div>
                            <div class="strengths-list">
                                ${suggestions.map(s => `<div class="strength-item"><span class="material-symbols-outlined" style="font-size: 0.875rem;">star</span>${s}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                aiEvalHtml += `</div>`;
                aiEvalSection.innerHTML = aiEvalHtml;
            }

            if (evaluations.length === 0) {
                questionsList.innerHTML = '<p style="text-align: center; color: var(--text-muted);">暂无问题数据</p>';
                return;
            }

            questionsList.innerHTML = evaluations.map((item, index) => {
                const evalData = item.evaluation || {};
                const categoryIcons = {
                    'self_introduction': 'face',
                    'family': 'diversity_3',
                    'interests': 'sports_esports',
                    'school': 'school',
                    'daily_life': 'today',
                    'future': 'rocket_launch',
                    'problem_solving': 'psychology',
                    'values': 'favorite'
                };

                const categoryText = {
                    'self_introduction': '自我介绍',
                    'family': '家庭介绍',
                    'interests': '兴趣爱好',
                    'school': '学校生活',
                    'daily_life': '日常生活',
                    'future': '未来展望',
                    'problem_solving': '情境处理',
                    'values': '价值观'
                };

                // Find category from question
                let category = '其他';
                let categoryIcon = 'help';
                for (const q of session.questions || []) {
                    if (q.question === item.question) {
                        category = categoryText[q.category] || q.category;
                        categoryIcon = categoryIcons[q.category] || 'help';
                        break;
                    }
                }

                const strengths = evalData.strengths || [];
                const strengthsHtml = strengths.length > 0
                    ? `<div class="strengths-list">
                        ${strengths.map(s => `<div class="strength-item"><span class="material-symbols-outlined" style="font-size: 0.875rem;">check_circle</span>${s}</div>`).join('')}
                       </div>`
                    : '';

                return `
                    <div class="question-card">
                        <div class="question-header">
                            <div class="question-category">
                                <span class="material-symbols-outlined" style="font-size: 0.875rem;">${categoryIcon}</span>
                                ${category}
                            </div>
                            <div class="question-score">${evalData.score || 0}分</div>
                        </div>
                        <div class="question-text"><strong>问题:</strong> ${item.question}</div>
                        <div class="answer-text"><strong>回答:</strong> ${item.answer}</div>
                        <div class="feedback-section">
                            <div class="feedback-title">
                                <span class="material-symbols-outlined" style="font-size: 0.875rem;">lightbulb</span>
                                面试官反馈
                            </div>
                            <div class="feedback-text">${evalData.feedback || '继续努力!'}</div>
                            ${strengthsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            // Hide loading
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showError() {
            document.getElementById('loading-overlay').innerHTML = `
                <div class="loading-text">无法加载报告</div>
                <button class="secondary-btn" style="margin-top: 1rem; width: auto;" onclick="loadReport()">重试</button>
            `;
        }

        function retryInterview() {
            window.location.href = '{{ url_for("mock_interview") }}';
        }

        function shareResult() {
            // TODO: Implement share functionality
            const score = document.getElementById('score-value').textContent;
            const schoolType = document.getElementById('school-type').textContent;
            const message = `AI模拟面试报告\n学校类型: ${schoolType}\n综合评分: ${score}分\n\n#AI面试官 #模拟面试`;

            if (navigator.share) {
                navigator.share({
                    title: 'AI模拟面试报告',
                    text: message
                }).catch(() => {});
            } else {
                // Copy to clipboard
                navigator.clipboard.writeText(message).then(() => {
                    alert('报告已复制到剪贴板!');
                }).catch(() => {
                    alert('分享内容:\n' + message);
                });
            }
        }

        // Load report on page load
        document.addEventListener('DOMContentLoaded', loadReport);
    </script>
</body>
</html>
